---
title:  "[파이썬] 데이터 탐색-분석용 데이터 탐색(3)"
date: 2020-03-31
categories: ['python']
tags: ['python', '파이썬']
---

## 1. 결측치

결측치 = 비어있는 값(DB에서 NULL과 비슷한 의미)

- 데이터 수집과정에서 발생한 오류로 인해 결측치를 포함하는 경우가 있다.

- 결측치가 있으면 함수가 동작하지 않거나 분석 결과가 왜곡되는 문제가 발생한다.
<br>

## 2. 결측치 제거

### 1) 데이터 프레임을 표 형태로 출력하는 모듈

모듈을 만들기 위한 패키지 설치

```
pip install prettytable
```

##### 예제코드

##### 샘플코드 sample.py

```python
#-----------------------------------------------------
# 데이터 프레임에서 사용할 샘플 데이터
#-----------------------------------------------------
# 어느 학급의 성적표를 표현한 2차원 리스트
grade_list = [  # 국  영  수  과
                 [98,  None, 88,   64],   # 철수
                 [88,  90,   62,   72],   # 영희
                 [92,  70,   None, None], # 민철
                 [63,  60,   31,   70],   # 수현
                 [120, 50,   None, 88]    # 호영
            ]

# 어느 학급의 성적표를 표현한 딕셔너리
grade_dic = {
    '국어': [98, 88, 92, 63, 120],
    '영어': [None, 90, 70, 60, 50],
    '수학': [88, 62, None, 31, None],
    '과학': [64, 72, None, 70, 88]
}

# 서울, 부산, 인천의 5년 단위 인구 분포
city_people = {
    "도시": ["서울", "서울", "서울", "부산", "부산", "부산", "인천", "인천"],
    "연도": ["2015", "2010", "2005", "2015", "2010", "2005", "2015", "2010"],
    "인구": [9904312, 9631482, 9762546, 3448737, 3393191, 3512547, 2890451, 2632035],
    "지역": ["수도권", "수도권", "수도권", "경상권", "경상권", "경상권", "수도권", "수도권"]
}

# 2017년 교통사고 조사
traffic = {
    'seoul'  : [ 3166, 2728, 3098, 3172, 3284, 3247, 3268, 3308, 3488, 3312, 3375, 3179 ],
    'busan'  : [ 927, 857, 988, 955, 1014, 974, 1029, 1040, 1058, 971, 958, 982 ],
    'daegu'  : [ 933, 982, 1049, 1032, 1083, 1117, 1076, 1080, 1174, 1163, 1146, 1135 ],
    'inchun' : [ 655, 586, 629, 669, 643, 627, 681, 657, 662, 606, 641, 663 ],
    'month'  : ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월']
}

# 어느 학교에서 임의로 선정한 학생들의 신장(cm단위)에 대한 자료
height = {
    '키': [170, 178, 171, 168, 173, 178, 171, 174, 170, 170,
           175, 170, 169, 166, 162, 170, 171, 175, 175, 171,
           170, 172, 179, 164, 170, 181, 178, 180, 177, 166,
           169, 168, 165, 163, 175, 166, 178, 165, 168, 167,
           177, 168, 177, 174, 174, 176, 169, 173, 167, 170,
           173, 170, 162, 182, 171]
}

```

##### print_df.py 코드

```python
# 모듈사용
from prettytable import PrettyTable
import pandas

#---------------------
# 데이터 프레임 출력함수
#---------------------
def print_df(df):
	# 변수의 타입을 확인한다.
	print(type(df))

	#타입이 DataFrame인 경우 사용
	if isinstance(df, pandas.core.frame.DataFrame):
		print(df.shape)

		# 파라미터로 전달된 데이터 프레임의 컬럼 이름들에 대한
		# 리스트를 사용하여 PrettyTable 객체 생성
		table = PrettyTable(['']+list(df.columns))

		#데이터 프레임의 각 행마다 반복
		for row in df.itertuples():
			#데이터 프레임의 각 행을 PrettyTable 객체에 추가
			table.add_row(row)

		# 결과를 문자열로 변환하여 출력
		print(str(table))
	# 데이터 프레임이 아닌 경우는 기본 출력 사용
	else:
		print(df)

	# 빈 줄 출력
	print("\n")
```

##### 구현코드 1

```python
# 모듈 및 샘플 데이터 참조
from print_df import print_df
from pandas import DataFrame
from sample import grade_dic

df = DataFrame(grade_dic, index=['철수', '영희', '민철', '수현', '호영'])
print_df(df)

# 결측치 여부 확인
# -> 각 열에 대해 결측치가 아닐 경우 False, 결측치는 True로 표시됨.
# -> isna() 함수도 같은 기능을 함.
empty = df.isnull()
print_df(empty)

# 결측치의 수를 파악하기 위해 각 열별로 합계 도출
# -> True에 대해서만 카운트
empty_sum = empty.sum()
print_df(empty_sum)

# 결측치가 있는 모든 행 삭제 (원본은 변화 없음, 삭제결과 리턴됨.)
na1 = df.dropna()

# -> 결측치가 삭제된 데이터 프레임 확인
print_df(na1)

# -> 결측치 값 개수 확인
print_df(na1.isnull().sum())
```

```
<class 'pandas.core.frame.DataFrame'>
(5, 4)
+------+------+------+------+------+
|      | 국어 | 영어 | 수학 | 과학 |
+------+------+------+------+------+
| 철수 |  98  | nan  | 88.0 | 64.0 |
| 영희 |  88  | 90.0 | 62.0 | 72.0 |
| 민철 |  92  | 70.0 | nan  | nan  |
| 수현 |  63  | 60.0 | 31.0 | 70.0 |
| 호영 | 120  | 50.0 | nan  | 88.0 |
+------+------+------+------+------+


<class 'pandas.core.frame.DataFrame'>
(5, 4)
+------+-------+-------+-------+-------+
|      |  국어 |  영어 |  수학 |  과학 |
+------+-------+-------+-------+-------+
| 철수 | False |  True | False | False |
| 영희 | False | False | False | False |
| 민철 | False | False |  True |  True |
| 수현 | False | False | False | False |
| 호영 | False | False |  True | False |
+------+-------+-------+-------+-------+


<class 'pandas.core.series.Series'>
국어    0
영어    1
수학    2
과학    1
dtype: int64

<class 'pandas.core.frame.DataFrame'>
(2, 4)
+------+------+------+------+------+
|      | 국어 | 영어 | 수학 | 과학 |
+------+------+------+------+------+
| 영희 |  88  | 90.0 | 62.0 | 72.0 |
| 수현 |  63  | 60.0 | 31.0 | 70.0 |
+------+------+------+------+------+


<class 'pandas.core.series.Series'>
국어    0
영어    0
수학    0
과학    0
dtype: int64
```

##### 구현코드 2(1 번에 이어서)

```python
# 결측치가 있는 모든 열 삭제
na2 = df.dropna(axis =1)

# -> 결측치가 삭제된 데이터 프레임 확인
print_df(na2)

# -> 결측치 값 개수 확인
print_df(na2.isnull().sum())

# 행의 모든 값이 결측치면 행을 삭제
na3 = df.dropna(how='all')
print_df(na3)

# 열의 모든 값이 결측치면 열을 삭제
na4 = df.dropna(how='all', axis=1)
print_df(na4)
```

```
<class 'pandas.core.frame.DataFrame'>
(5, 1)
+------+------+
|      | 국어 |
+------+------+
| 철수 |  98  |
| 영희 |  88  |
| 민철 |  92  |
| 수현 |  63  |
| 호영 | 120  |
+------+------+


<class 'pandas.core.series.Series'>
국어    0
dtype: int64


<class 'pandas.core.frame.DataFrame'>
(5, 4)
+------+------+------+------+------+
|      | 국어 | 영어 | 수학 | 과학 |
+------+------+------+------+------+
| 철수 |  98  | nan  | 88.0 | 64.0 |
| 영희 |  88  | 90.0 | 62.0 | 72.0 |
| 민철 |  92  | 70.0 | nan  | nan  |
| 수현 |  63  | 60.0 | 31.0 | 70.0 |
| 호영 | 120  | 50.0 | nan  | 88.0 |
+------+------+------+------+------+


<class 'pandas.core.frame.DataFrame'>
(5, 4)
+------+------+------+------+------+
|      | 국어 | 영어 | 수학 | 과학 |
+------+------+------+------+------+
| 철수 |  98  | nan  | 88.0 | 64.0 |
| 영희 |  88  | 90.0 | 62.0 | 72.0 |
| 민철 |  92  | 70.0 | nan  | nan  |
| 수현 |  63  | 60.0 | 31.0 | 70.0 |
| 호영 | 120  | 50.0 | nan  | 88.0 |
+------+------+------+------+------+
```
<br>

### 2) 결측치 제거의 문제점

- 데이터가 많고 결측치가 얼마 없는 경우에는 결측치를 제거하더라도 데이터 분석에 영향이 적다

- 데이터가 적고 결측치가 많은 경우, 결측치를 제거하면 유의미한 데이터 분석이 이루어 졌다고 말할 수 없다.


## 3. 결측치 대체

- 결측치를 제거하는 대신 다른 값을 채워넣는 방법을 사용하여 데이터가 손실되어 분석결과가 왜곡되는 문제를 보완할 수 있다.

- 결측치 대체법의 종류

    - 평균, 최대, 최소값 같은 대표값을 구해 모든 결측치를 하나의 값으로 일괄 대체한다.

    - 통계분석 기법으로 각 결측치의 예측값을 추정하여 대체한다.

### `sklearn` 모듈을 사용한 결측치 처리

명령 프롬프트를 사용하여 모듈을 설치

```
pip install sklearn
```

##### 예제코드

- sample.py 및 printdf 모듈은 위의 코드로 대체함.

##### 구현코드

```python
# 모듈 참조
from print_df import print_df
from pandas import DataFrame
from sklearn.impute import SimpleImputer
import numpy

# 데이터 참조하여 성적표 데이터 프레임 만들기
from sample import grade_dic
df = DataFrame(grade_dic, index=['철수', '영희', '민철','수현', '호영'])
print_df(df)

# 결측치를 특정값으로 채움
re_df1 = df.fillna(value =50)
print_df(re_df1)

# 결측치를 정제할 규칙 정의
# -> 각 열단위로 평균(strategy='mean')을 결측치(missing_values)에 지정
# -> strategy 옵션: mean=평균, median=중앙값, most_frequent: 최빈값(가장 많이 관측되는 수)
imr = SimpleImputer(missing_values = numpy.nan, strategy='mean')

# dataframe의 값에 대해 규칙 적용
df_imr = imr.fit_transform(df.values)
print_df(df_imr)

# 적용된 규칙으로 새로운 데이터 프레임 생성
re_df2 = DataFrame(df_imr, index=df.index, columns=df.columns)
print_df(re_df2)
```

```
<class 'pandas.core.frame.DataFrame'>
(5, 4)
+------+------+------+------+------+
|      | 국어 | 영어 | 수학 | 과학 |
+------+------+------+------+------+
| 철수 |  98  | nan  | 88.0 | 64.0 |
| 영희 |  88  | 90.0 | 62.0 | 72.0 |
| 민철 |  92  | 70.0 | nan  | nan  |
| 수현 |  63  | 60.0 | 31.0 | 70.0 |
| 호영 | 120  | 50.0 | nan  | 88.0 |
+------+------+------+------+------+


<class 'pandas.core.frame.DataFrame'>
(5, 4)
+------+------+------+------+------+
|      | 국어 | 영어 | 수학 | 과학 |
+------+------+------+------+------+
| 철수 |  98  | 50.0 | 88.0 | 64.0 |
| 영희 |  88  | 90.0 | 62.0 | 72.0 |
| 민철 |  92  | 70.0 | 50.0 | 50.0 |
| 수현 |  63  | 60.0 | 31.0 | 70.0 |
| 호영 | 120  | 50.0 | 50.0 | 88.0 |
+------+------+------+------+------+


<class 'numpy.ndarray'>
[[ 98.          67.5         88.          64.        ]
 [ 88.          90.          62.          72.        ]
 [ 92.          70.          60.33333333  73.5       ]
 [ 63.          60.          31.          70.        ]
 [120.          50.          60.33333333  88.        ]]


<class 'pandas.core.frame.DataFrame'>
(5, 4)
+------+-------+------+--------------------+------+
|      |  국어 | 영어 |        수학        | 과학 |
+------+-------+------+--------------------+------+
| 철수 |  98.0 | 67.5 |        88.0        | 64.0 |
| 영희 |  88.0 | 90.0 |        62.0        | 72.0 |
| 민철 |  92.0 | 70.0 | 60.333333333333336 | 73.5 |
| 수현 |  63.0 | 60.0 |        31.0        | 70.0 |
| 호영 | 120.0 | 50.0 | 60.333333333333336 | 88.0 |
+------+-------+------+--------------------+------+

```
<br>

## 4. 이상치

### 1) 이상치

- 정상 범주에서 크게 벗어난 값 (이상한 값)

- 데이터 수집 과정에서 오류가 발생될 수 있기 때문에 현장에서 만들어진 실제 데이터에는 이상치가 포함될 수 있다.

- 이상치가 포함되어 있으면 분석 결과가 왜곡되기 때문에 분석에 앞서 이상치를 제거하는 작업을 해야 한다.

### 2) 극단치

- 논리적으로 존재할 수 있지만 극단적으로 크거나 작은 값

    - ex) 몸무게가 200 kg 이상인 값이 있다면 존재할 가능성은 있지만 매우 드문 경우이므로 극단치라고 볼 수 있다.

- 정상범위를 설정하여 극단치를 제거

    - 논리적인 판단으로 극단치 제거
    - 통계적인 기준을 이용한 극단치 제거

- 중심에서 크게 벗어난 값을 극단치로 간주

- 극단치는 원으로 표시됨.

![극단치](/assets/Images/python/chapter35/1_extvalue.JPG)

## 5. 이상치 정제

##### 에제코드

- sample.py와 print_df는 위의 코드를 참조

##### 구현코드 1

```python
# 모듈 참조
from print_df import print_df
from pandas import DataFrame
from matplotlib import pyplot
from sklearn.impute import SimpleImputer
import numpy

#데이터를 참조하여 성적표 데이터 프레임 만들기
from sample import grade_dic
df = DataFrame(grade_dic, index=['철수','영희', '민철', '수현','호영'])

# 이상치 존재 여부 확인을 위해 상자그림 표시
pyplot.rcParams["font.family"] = "NanumGothic"
pyplot.rcParams["font.size"] = 14
pyplot.rcParams["figure.figsize"] = (12,8)

pyplot.figure()
df.boxplot()
pyplot.savefig('refine.png', dpi=300)
pyplot.show()
pyplot.close()
```

![결측치 분석](/assets/Images/python/chapter35/2_boxplot.JPG)

- 원으로 표시된 이상치가 3개 검출되는 것을 확인할 수 있다.

- 시험 점수가 평균점수 분포에서 멀어졌다고 이상치로 판단할 수 없다.

- 국어 점수의 이상치 중 120은 시험 점수로 평가되기 힘드므로 결측치로 변환하여 정제해야 한다.

##### 구현코드 2

```python
# 국어점수에 대한 이상치 필터링
r = df.query('국어> 100')
print_df(r)

#필터링 된 이상치 데이터에 대한 인덱스 추출
r_index = list(r.index)
print_df(r_index)

# 이상치를 갖는 인덱스에 대한 국어 점수를 결측치로 변경
for i in r_index:
	df.loc[i,'국어'] = numpy.nan
print_df(df)

# 결측치를 정제할 규칙 정의 -> 결측치에 대해 평균점수 부여
imr = SimpleImputer(missing_values=numpy.nan, strategy='mean')

# dataFrame의 값에 대해 규칙 적용
df_imr = imr.fit_transform(df.values)

# 적용된 규칙으로 새로운 데이터 프레임 생성
re_df2 = DataFrame(df_imr, index=list(df.index), columns = list(df.columns))
print_df(re_df2)
```

```
<class 'pandas.core.frame.DataFrame'>
(1, 4)
+------+------+------+------+------+
|      | 국어 | 영어 | 수학 | 과학 |
+------+------+------+------+------+
| 호영 | 120  | 50.0 | nan  | 88.0 |
+------+------+------+------+------+


<class 'list'>
['호영']


<class 'pandas.core.frame.DataFrame'>
(5, 4)
+------+------+------+------+------+
|      | 국어 | 영어 | 수학 | 과학 |
+------+------+------+------+------+
| 철수 | 98.0 | nan  | 88.0 | 64.0 |
| 영희 | 88.0 | 90.0 | 62.0 | 72.0 |
| 민철 | 92.0 | 70.0 | nan  | nan  |
| 수현 | 63.0 | 60.0 | 31.0 | 70.0 |
| 호영 | nan  | 50.0 | nan  | 88.0 |
+------+------+------+------+------+


<class 'pandas.core.frame.DataFrame'>
(5, 4)
+------+-------+------+--------------------+------+
|      |  국어 | 영어 |        수학        | 과학 |
+------+-------+------+--------------------+------+
| 철수 |  98.0 | 67.5 |        88.0        | 64.0 |
| 영희 |  88.0 | 90.0 |        62.0        | 72.0 |
| 민철 |  92.0 | 70.0 | 60.333333333333336 | 73.5 |
| 수현 |  63.0 | 60.0 |        31.0        | 70.0 |
| 호영 | 85.25 | 50.0 | 60.333333333333336 | 88.0 |
+------+-------+------+--------------------+------+
```

참조 : 호쌤의 교육자료, (<https://blog.itpaper.co.kr/>)